#!/usr/bin/env ruby

$LOAD_PATH.unshift(File.expand_path('../../lib', __FILE__))
require 'rubynas'

case ARGV.first
when 'migrate'
  puts 'Migration of the database'
  path = File.expand_path('../../lib/rubynas/db/migrate', __FILE__)
  ActiveRecord::Migrator.migrate path
when 'server'
  require 'rack'
  require 'puma'
  require 'rack/handler/puma'
  require 'dnssd'
  require 'rubynas/version'

  options = {
    :Host => '0.0.0.0',
    :Port => (ENV['PORT'] || 5100).to_i,
    :Threads => '0:16',
    :Verbose => false
  }

  text_record = DNSSD::TextRecord.new 'Version' => Rubynas::VERSION,
                                      'Path' => '/api'
  name = 'rubynas'
  type = '_rubynas._tcp'
  domain = host = nil
  port = options[:Port]
  DNSSD.register name, type, domain, port, text_record

  Rack::Handler::Puma.run(Rubynas::Application, options) do |server|
    [:INT, :TERM].each { |sig| trap(sig) { server.stop } }
  end
end
